<!doctype html>
<html lang="ro">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Articol — Romania Din Suflet</title>
    <meta name="description" content="Articol — Romania Din Suflet" />
    <!-- Google AdSense: set to your real ca-pub-... to enable ads -->
    <meta name="adsense-client" content="ca-pub-9846184063862431" />
    <!-- AdSense site verification snippet (required for review) -->
    <script
      async
      data-adsense="true"
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9846184063862431"
      crossorigin="anonymous"
    ></script>
    <!-- In-article ads (inside article text). Provide one or more numeric slot IDs, comma-separated. -->
    <meta name="adsense-article-incontent-slots" content="REPLACE_ME" />
    <!-- Insert an ad after every N paragraphs (example: 3 = after 3rd, 6th, 9th...). -->
    <meta name="adsense-article-incontent-every" content="3" />
    <!-- Start inserting only after paragraph N (example: 2 = after the 2nd paragraph). -->
    <meta name="adsense-article-incontent-start" content="2" />
    <link rel="icon" href="./assets/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <a class="skip-link" href="#main">Sari la conținut</a>

    <header class="site-header">
      <div class="container header-inner">
        <a class="brand" href="./" aria-label="Romania Din Suflet - Acasă">
          <img
            class="brand-mark"
            src="./assets/logo.svg"
            width="40"
            height="40"
            alt=""
            aria-hidden="true"
          />
          <div class="brand-text">
            <span class="brand-name">Romania</span>
            <span class="brand-sub">Din Suflet</span>
          </div>
        </a>
      </div>
    </header>

    <main id="main" class="site-main">
      <section class="section" aria-labelledby="article-title">
        <div class="container">
          <div class="section-head">
            <h1 class="section-title" id="article-title">Se încarcă…</h1>
            <p class="section-muted" id="article-meta"></p>
          </div>

          <!-- AdSense: fill data-ad-slot with your real slot id to enable -->
          <div class="ad-section" data-ad="article_top" aria-label="Publicitate" hidden>
            <div class="ad-label" aria-hidden="true">Publicitate</div>
            <ins
              class="adsbygoogle ad-slot"
              style="display: block"
              data-ad-client="ca-pub-REPLACE_ME"
              data-ad-slot="REPLACE_ME"
              data-ad-format="auto"
              data-full-width-responsive="true"
            ></ins>
          </div>

          <img
            id="article-image"
            class="article-hero"
            alt=""
            loading="lazy"
            hidden
          />

          <div id="article-content" class="article-content"></div>
          <p class="section-muted" id="article-error" hidden>
            Nu am putut încărca articolul.
          </p>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container footer-inner">
        <p class="footer-brand">Romania Din Suflet</p>
        <p class="footer-muted">
          © <span id="year"></span> Toate drepturile rezervate. | 
          <a href="./privacy.html" style="color: inherit; text-decoration: underline;">Politica de Confidențialitate</a>
        </p>
      </div>
    </footer>

    <script src="./ads.js" defer></script>
    <script>
      (() => {
        const yearEl = document.getElementById("year");
        if (yearEl) yearEl.textContent = String(new Date().getFullYear());

        const titleEl = document.getElementById("article-title");
        const metaEl = document.getElementById("article-meta");
        const contentEl = document.getElementById("article-content");
        const imageEl = document.getElementById("article-image");
        const errorEl = document.getElementById("article-error");

        const params = new URLSearchParams(location.search);
        const slug = params.get("slug");

        if (!slug) {
          if (errorEl) errorEl.hidden = false;
          return;
        }

        function escapeHtml(str) {
          return String(str)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        function getMetaContent(name) {
          const el = document.querySelector(`meta[name="${CSS.escape(name)}"]`);
          return el instanceof HTMLMetaElement ? (el.content || "").trim() : "";
        }

        function getInContentAdConfig() {
          const slotsRaw = getMetaContent("adsense-article-incontent-slots");
          const everyRaw = getMetaContent("adsense-article-incontent-every");
          const startRaw = getMetaContent("adsense-article-incontent-start");

          const slots = slotsRaw
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean)
            .filter((s) => /^\d{6,}$/.test(s));

          const every = Number.parseInt(String(everyRaw || "3"), 10);
          const start = Number.parseInt(String(startRaw || "2"), 10);

          return {
            slots,
            every: Number.isFinite(every) && every > 0 ? every : 3,
            start: Number.isFinite(start) && start > 0 ? start : 2,
          };
        }

        function renderInContentAd({ slot }) {
          // Container is hidden by default; ads.js will unhide when properly configured.
          return `
            <div class="ad-section ad-incontent" data-ad="article_incontent" aria-label="Publicitate" hidden>
              <div class="ad-label" aria-hidden="true">Publicitate</div>
              <ins
                class="adsbygoogle ad-slot"
                style="display: block"
                data-ad-client="ca-pub-REPLACE_ME"
                data-ad-slot="${escapeHtml(String(slot))}"
                data-ad-format="auto"
                data-full-width-responsive="true"
              ></ins>
            </div>
          `;
        }

        function maybeInitAds() {
          const fn = window.__RDS_INIT_ADS;
          if (typeof fn === "function") {
            try {
              fn();
            } catch {
              // Ignore (ad blockers, CSP, etc). Site should still function.
            }
          }
        }

        async function load() {
          try {
            const res = await fetch(`/api/articles/${encodeURIComponent(slug)}`, {
              headers: { Accept: "application/json" },
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const a = await res.json();

            if (titleEl) titleEl.textContent = a?.title || "Articol";
            if (metaEl) {
              metaEl.textContent = a?.publishedAt
                ? new Date(a.publishedAt).toLocaleDateString("ro-RO", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                  })
                : "";
            }

            if (imageEl && a?.imageUrl) {
              imageEl.src = a.imageUrl;
              imageEl.hidden = false;
            }

            // Body is stored as plain text; render safe paragraphs.
            const body = String(a?.content || "");
            const rawParagraphs = body
              .split(/\n{2,}/g)
              .map((p) => p.trim())
              .filter(Boolean);

            const { slots, every, start } = getInContentAdConfig();
            const parts = [];
            let slotIndex = 0;

            for (let i = 0; i < rawParagraphs.length; i += 1) {
              parts.push(`<p>${escapeHtml(rawParagraphs[i])}</p>`);

              const paragraphNumber = i + 1;
              const canInsert = slots.length > 0 && paragraphNumber >= start && i !== rawParagraphs.length - 1;
              const shouldInsert = canInsert && (paragraphNumber - start + 1) % every === 0;
              if (shouldInsert) {
                const slot = slots[slotIndex % slots.length];
                slotIndex += 1;
                parts.push(renderInContentAd({ slot }));
              }
            }

            if (contentEl) contentEl.innerHTML = parts.join("") || "<p></p>";
            maybeInitAds();
          } catch (e) {
            if (errorEl) errorEl.hidden = false;
          }
        }

        load();
      })();
    </script>
  </body>
</html>

