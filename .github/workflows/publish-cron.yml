name: Publish Cron

on:
  schedule:
    - cron: "0 * * * *" # every hour
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Call publish endpoint (batch)
        shell: bash
        run: |
          set -euo pipefail
          MAX_CALLS_PER_RUN="${MAX_CALLS_PER_RUN:-10}"
          for i in $(seq 1 "$MAX_CALLS_PER_RUN"); do
            echo "call ${i}/${MAX_CALLS_PER_RUN}"
            out="$(curl -fsS "$CRON_URL")"
            echo "$out"
            echo
            if echo "$out" | grep -q "No pending sources"; then
              echo "Queue empty; stopping early."
              break
            fi
          done
        env:
          CRON_URL: ${{ secrets.CRON_URL }}
          MAX_CALLS_PER_RUN: 10

