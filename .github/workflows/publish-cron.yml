name: Publish Cron

on:
  schedule:
    - cron: "0 * * * *" # every hour
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Call publish endpoint (batch)
        run: node -e "const max=Number(process.env.MAX_CALLS_PER_RUN||'10');const url=process.env.CRON_URL;if(!url) throw new Error('Missing CRON_URL');let processed=0,failures=0,noPending=false;for(let i=0;i<max;i++){const res=await fetch(url,{headers:{'user-agent':'RDS-PublishCron/1.0'}});const text=await res.text();let data=null;try{data=JSON.parse(text);}catch{}console.log(`call ${i+1}/${max}: status=${res.status}`);console.log(text);if(data?.message==='No pending sources.'){noPending=true;break;}if(data?.processed?.publishedSlug) processed+=1;if(data?.ok===false) failures+=1;}console.log(JSON.stringify({processed,failures,noPending,max},null,2));"
        env:
          CRON_URL: ${{ secrets.CRON_URL }}
          MAX_CALLS_PER_RUN: 10

